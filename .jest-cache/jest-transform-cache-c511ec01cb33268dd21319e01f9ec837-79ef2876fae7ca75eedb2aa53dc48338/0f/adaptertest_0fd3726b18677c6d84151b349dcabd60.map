{"file":"/Users/zfkc/Desktop/03-移动端项目/taro-bluetooth-print/tests/adapter.test.ts","mappings":"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","names":[],"sources":["/Users/zfkc/Desktop/03-移动端项目/taro-bluetooth-print/tests/adapter.test.ts"],"sourcesContent":["\nimport { TaroAdapter } from '../src/adapters/TaroAdapter';\nimport { PrinterState } from '../src/types';\n\n// Mock Taro\nconst mockWriteBLECharacteristicValue = jest.fn();\nconst mockGetBLEDeviceServices = jest.fn();\nconst mockGetBLEDeviceCharacteristics = jest.fn();\n\nglobal.Taro = {\n  writeBLECharacteristicValue: mockWriteBLECharacteristicValue,\n  getBLEDeviceServices: mockGetBLEDeviceServices,\n  getBLEDeviceCharacteristics: mockGetBLEDeviceCharacteristics,\n  createBLEConnection: jest.fn(),\n  closeBLEConnection: jest.fn(),\n  onBLEConnectionStateChange: jest.fn(),\n} as any;\n\ndescribe('TaroAdapter Weak Network', () => {\n  let adapter: TaroAdapter;\n  const deviceId = 'test-device';\n  const serviceId = 'service-uuid';\n  const charId = 'char-uuid';\n\n  beforeEach(() => {\n    adapter = new TaroAdapter();\n    jest.clearAllMocks();\n\n    // Setup default mocks\n    mockGetBLEDeviceServices.mockResolvedValue({\n      services: [{ uuid: serviceId }]\n    });\n    mockGetBLEDeviceCharacteristics.mockResolvedValue({\n      characteristics: [{ uuid: charId, properties: { write: true } }]\n    });\n  });\n\n  test('write retries on failure', async () => {\n    // Mock write to fail twice then succeed\n    mockWriteBLECharacteristicValue\n      .mockRejectedValueOnce(new Error('Fail 1'))\n      .mockRejectedValueOnce(new Error('Fail 2'))\n      .mockResolvedValue(undefined);\n\n    const data = new Uint8Array([1, 2, 3]).buffer;\n    // Set retries to 2\n    await adapter.write(deviceId, data, { retries: 2, delay: 1 });\n\n    // Should have called write 3 times (1 initial + 2 retries)\n    expect(mockWriteBLECharacteristicValue).toHaveBeenCalledTimes(3);\n  });\n\n  test('write fails after retries exhausted', async () => {\n    // Mock write to fail always\n    mockWriteBLECharacteristicValue.mockRejectedValue(new Error('Fail Always'));\n\n    const data = new Uint8Array([1, 2, 3]).buffer;\n\n    // Set retries to 1\n    await expect(adapter.write(deviceId, data, { retries: 1, delay: 1 }))\n      .rejects.toThrow('Fail Always');\n\n    // Should have called write 2 times (1 initial + 1 retry)\n    expect(mockWriteBLECharacteristicValue).toHaveBeenCalledTimes(2);\n  });\n\n  test('write respects chunk size', async () => {\n    mockWriteBLECharacteristicValue.mockResolvedValue(undefined);\n\n    // 10 bytes data\n    const data = new Uint8Array(10).buffer;\n\n    // Chunk size 4. Should be 3 chunks (4, 4, 2).\n    await adapter.write(deviceId, data, { chunkSize: 4, delay: 1 });\n\n    expect(mockWriteBLECharacteristicValue).toHaveBeenCalledTimes(3);\n  });\n});\n"],"version":3}