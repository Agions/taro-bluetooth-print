b54e09997c4053c60d42defecc3d859a
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const TaroAdapter_1 = require("../src/adapters/TaroAdapter");
// Mock Taro
const mockWriteBLECharacteristicValue = jest.fn();
const mockGetBLEDeviceServices = jest.fn();
const mockGetBLEDeviceCharacteristics = jest.fn();
global.Taro = {
    writeBLECharacteristicValue: mockWriteBLECharacteristicValue,
    getBLEDeviceServices: mockGetBLEDeviceServices,
    getBLEDeviceCharacteristics: mockGetBLEDeviceCharacteristics,
    createBLEConnection: jest.fn(),
    closeBLEConnection: jest.fn(),
    onBLEConnectionStateChange: jest.fn(),
};
describe('TaroAdapter Weak Network', () => {
    let adapter;
    const deviceId = 'test-device';
    const serviceId = 'service-uuid';
    const charId = 'char-uuid';
    beforeEach(() => {
        adapter = new TaroAdapter_1.TaroAdapter();
        jest.clearAllMocks();
        // Setup default mocks
        mockGetBLEDeviceServices.mockResolvedValue({
            services: [{ uuid: serviceId }]
        });
        mockGetBLEDeviceCharacteristics.mockResolvedValue({
            characteristics: [{ uuid: charId, properties: { write: true } }]
        });
    });
    test('write retries on failure', async () => {
        // Mock write to fail twice then succeed
        mockWriteBLECharacteristicValue
            .mockRejectedValueOnce(new Error('Fail 1'))
            .mockRejectedValueOnce(new Error('Fail 2'))
            .mockResolvedValue(undefined);
        const data = new Uint8Array([1, 2, 3]).buffer;
        // Set retries to 2
        await adapter.write(deviceId, data, { retries: 2, delay: 1 });
        // Should have called write 3 times (1 initial + 2 retries)
        expect(mockWriteBLECharacteristicValue).toHaveBeenCalledTimes(3);
    });
    test('write fails after retries exhausted', async () => {
        // Mock write to fail always
        mockWriteBLECharacteristicValue.mockRejectedValue(new Error('Fail Always'));
        const data = new Uint8Array([1, 2, 3]).buffer;
        // Set retries to 1
        await expect(adapter.write(deviceId, data, { retries: 1, delay: 1 }))
            .rejects.toThrow('Fail Always');
        // Should have called write 2 times (1 initial + 1 retry)
        expect(mockWriteBLECharacteristicValue).toHaveBeenCalledTimes(2);
    });
    test('write respects chunk size', async () => {
        mockWriteBLECharacteristicValue.mockResolvedValue(undefined);
        // 10 bytes data
        const data = new Uint8Array(10).buffer;
        // Chunk size 4. Should be 3 chunks (4, 4, 2).
        await adapter.write(deviceId, data, { chunkSize: 4, delay: 1 });
        expect(mockWriteBLECharacteristicValue).toHaveBeenCalledTimes(3);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3pma2MvRGVza3RvcC8wMy3np7vliqjnq6/pobnnm64vdGFyby1ibHVldG9vdGgtcHJpbnQvdGVzdHMvYWRhcHRlci50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQ0EsNkRBQTBEO0FBRzFELFlBQVk7QUFDWixNQUFNLCtCQUErQixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNsRCxNQUFNLHdCQUF3QixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUMzQyxNQUFNLCtCQUErQixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUVsRCxNQUFNLENBQUMsSUFBSSxHQUFHO0lBQ1osMkJBQTJCLEVBQUUsK0JBQStCO0lBQzVELG9CQUFvQixFQUFFLHdCQUF3QjtJQUM5QywyQkFBMkIsRUFBRSwrQkFBK0I7SUFDNUQsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUM5QixrQkFBa0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQzdCLDBCQUEwQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Q0FDL0IsQ0FBQztBQUVULFFBQVEsQ0FBQywwQkFBMEIsRUFBRSxHQUFHLEVBQUU7SUFDeEMsSUFBSSxPQUFvQixDQUFDO0lBQ3pCLE1BQU0sUUFBUSxHQUFHLGFBQWEsQ0FBQztJQUMvQixNQUFNLFNBQVMsR0FBRyxjQUFjLENBQUM7SUFDakMsTUFBTSxNQUFNLEdBQUcsV0FBVyxDQUFDO0lBRTNCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxPQUFPLEdBQUcsSUFBSSx5QkFBVyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXJCLHNCQUFzQjtRQUN0Qix3QkFBd0IsQ0FBQyxpQkFBaUIsQ0FBQztZQUN6QyxRQUFRLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQztTQUNoQyxDQUFDLENBQUM7UUFDSCwrQkFBK0IsQ0FBQyxpQkFBaUIsQ0FBQztZQUNoRCxlQUFlLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUM7U0FDakUsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsMEJBQTBCLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDMUMsd0NBQXdDO1FBQ3hDLCtCQUErQjthQUM1QixxQkFBcUIsQ0FBQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUMxQyxxQkFBcUIsQ0FBQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUMxQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVoQyxNQUFNLElBQUksR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDOUMsbUJBQW1CO1FBQ25CLE1BQU0sT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUU5RCwyREFBMkQ7UUFDM0QsTUFBTSxDQUFDLCtCQUErQixDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbkUsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMscUNBQXFDLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDckQsNEJBQTRCO1FBQzVCLCtCQUErQixDQUFDLGlCQUFpQixDQUFDLElBQUksS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFFNUUsTUFBTSxJQUFJLEdBQUcsSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBRTlDLG1CQUFtQjtRQUNuQixNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ2xFLE9BQU8sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFbEMseURBQXlEO1FBQ3pELE1BQU0sQ0FBQywrQkFBK0IsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25FLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDJCQUEyQixFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzNDLCtCQUErQixDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTdELGdCQUFnQjtRQUNoQixNQUFNLElBQUksR0FBRyxJQUFJLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFFdkMsOENBQThDO1FBQzlDLE1BQU0sT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsU0FBUyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVoRSxNQUFNLENBQUMsK0JBQStCLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy96ZmtjL0Rlc2t0b3AvMDMt56e75Yqo56uv6aG555uuL3Rhcm8tYmx1ZXRvb3RoLXByaW50L3Rlc3RzL2FkYXB0ZXIudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IFRhcm9BZGFwdGVyIH0gZnJvbSAnLi4vc3JjL2FkYXB0ZXJzL1Rhcm9BZGFwdGVyJztcbmltcG9ydCB7IFByaW50ZXJTdGF0ZSB9IGZyb20gJy4uL3NyYy90eXBlcyc7XG5cbi8vIE1vY2sgVGFyb1xuY29uc3QgbW9ja1dyaXRlQkxFQ2hhcmFjdGVyaXN0aWNWYWx1ZSA9IGplc3QuZm4oKTtcbmNvbnN0IG1vY2tHZXRCTEVEZXZpY2VTZXJ2aWNlcyA9IGplc3QuZm4oKTtcbmNvbnN0IG1vY2tHZXRCTEVEZXZpY2VDaGFyYWN0ZXJpc3RpY3MgPSBqZXN0LmZuKCk7XG5cbmdsb2JhbC5UYXJvID0ge1xuICB3cml0ZUJMRUNoYXJhY3RlcmlzdGljVmFsdWU6IG1vY2tXcml0ZUJMRUNoYXJhY3RlcmlzdGljVmFsdWUsXG4gIGdldEJMRURldmljZVNlcnZpY2VzOiBtb2NrR2V0QkxFRGV2aWNlU2VydmljZXMsXG4gIGdldEJMRURldmljZUNoYXJhY3RlcmlzdGljczogbW9ja0dldEJMRURldmljZUNoYXJhY3RlcmlzdGljcyxcbiAgY3JlYXRlQkxFQ29ubmVjdGlvbjogamVzdC5mbigpLFxuICBjbG9zZUJMRUNvbm5lY3Rpb246IGplc3QuZm4oKSxcbiAgb25CTEVDb25uZWN0aW9uU3RhdGVDaGFuZ2U6IGplc3QuZm4oKSxcbn0gYXMgYW55O1xuXG5kZXNjcmliZSgnVGFyb0FkYXB0ZXIgV2VhayBOZXR3b3JrJywgKCkgPT4ge1xuICBsZXQgYWRhcHRlcjogVGFyb0FkYXB0ZXI7XG4gIGNvbnN0IGRldmljZUlkID0gJ3Rlc3QtZGV2aWNlJztcbiAgY29uc3Qgc2VydmljZUlkID0gJ3NlcnZpY2UtdXVpZCc7XG4gIGNvbnN0IGNoYXJJZCA9ICdjaGFyLXV1aWQnO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGFkYXB0ZXIgPSBuZXcgVGFyb0FkYXB0ZXIoKTtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcblxuICAgIC8vIFNldHVwIGRlZmF1bHQgbW9ja3NcbiAgICBtb2NrR2V0QkxFRGV2aWNlU2VydmljZXMubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgc2VydmljZXM6IFt7IHV1aWQ6IHNlcnZpY2VJZCB9XVxuICAgIH0pO1xuICAgIG1vY2tHZXRCTEVEZXZpY2VDaGFyYWN0ZXJpc3RpY3MubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgY2hhcmFjdGVyaXN0aWNzOiBbeyB1dWlkOiBjaGFySWQsIHByb3BlcnRpZXM6IHsgd3JpdGU6IHRydWUgfSB9XVxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCd3cml0ZSByZXRyaWVzIG9uIGZhaWx1cmUnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gTW9jayB3cml0ZSB0byBmYWlsIHR3aWNlIHRoZW4gc3VjY2VlZFxuICAgIG1vY2tXcml0ZUJMRUNoYXJhY3RlcmlzdGljVmFsdWVcbiAgICAgIC5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2UobmV3IEVycm9yKCdGYWlsIDEnKSlcbiAgICAgIC5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2UobmV3IEVycm9yKCdGYWlsIDInKSlcbiAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xuXG4gICAgY29uc3QgZGF0YSA9IG5ldyBVaW50OEFycmF5KFsxLCAyLCAzXSkuYnVmZmVyO1xuICAgIC8vIFNldCByZXRyaWVzIHRvIDJcbiAgICBhd2FpdCBhZGFwdGVyLndyaXRlKGRldmljZUlkLCBkYXRhLCB7IHJldHJpZXM6IDIsIGRlbGF5OiAxIH0pO1xuXG4gICAgLy8gU2hvdWxkIGhhdmUgY2FsbGVkIHdyaXRlIDMgdGltZXMgKDEgaW5pdGlhbCArIDIgcmV0cmllcylcbiAgICBleHBlY3QobW9ja1dyaXRlQkxFQ2hhcmFjdGVyaXN0aWNWYWx1ZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDMpO1xuICB9KTtcblxuICB0ZXN0KCd3cml0ZSBmYWlscyBhZnRlciByZXRyaWVzIGV4aGF1c3RlZCcsIGFzeW5jICgpID0+IHtcbiAgICAvLyBNb2NrIHdyaXRlIHRvIGZhaWwgYWx3YXlzXG4gICAgbW9ja1dyaXRlQkxFQ2hhcmFjdGVyaXN0aWNWYWx1ZS5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ0ZhaWwgQWx3YXlzJykpO1xuXG4gICAgY29uc3QgZGF0YSA9IG5ldyBVaW50OEFycmF5KFsxLCAyLCAzXSkuYnVmZmVyO1xuXG4gICAgLy8gU2V0IHJldHJpZXMgdG8gMVxuICAgIGF3YWl0IGV4cGVjdChhZGFwdGVyLndyaXRlKGRldmljZUlkLCBkYXRhLCB7IHJldHJpZXM6IDEsIGRlbGF5OiAxIH0pKVxuICAgICAgLnJlamVjdHMudG9UaHJvdygnRmFpbCBBbHdheXMnKTtcblxuICAgIC8vIFNob3VsZCBoYXZlIGNhbGxlZCB3cml0ZSAyIHRpbWVzICgxIGluaXRpYWwgKyAxIHJldHJ5KVxuICAgIGV4cGVjdChtb2NrV3JpdGVCTEVDaGFyYWN0ZXJpc3RpY1ZhbHVlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gIH0pO1xuXG4gIHRlc3QoJ3dyaXRlIHJlc3BlY3RzIGNodW5rIHNpemUnLCBhc3luYyAoKSA9PiB7XG4gICAgbW9ja1dyaXRlQkxFQ2hhcmFjdGVyaXN0aWNWYWx1ZS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xuXG4gICAgLy8gMTAgYnl0ZXMgZGF0YVxuICAgIGNvbnN0IGRhdGEgPSBuZXcgVWludDhBcnJheSgxMCkuYnVmZmVyO1xuXG4gICAgLy8gQ2h1bmsgc2l6ZSA0LiBTaG91bGQgYmUgMyBjaHVua3MgKDQsIDQsIDIpLlxuICAgIGF3YWl0IGFkYXB0ZXIud3JpdGUoZGV2aWNlSWQsIGRhdGEsIHsgY2h1bmtTaXplOiA0LCBkZWxheTogMSB9KTtcblxuICAgIGV4cGVjdChtb2NrV3JpdGVCTEVDaGFyYWN0ZXJpc3RpY1ZhbHVlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=