name: Monitoring and Notifications

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹å‘é€æ—¥æŠ¥
    - cron: '0 8 * * *'
    # æ¯å‘¨ä¸€æ—©ä¸Š9ç‚¹å‘é€å‘¨æŠ¥
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      notification-type:
        description: 'Notification type'
        required: true
        default: 'daily-report'
        type: choice
        options:
          - daily-report
          - weekly-report
          - monthly-report
          - custom
      channels:
        description: 'Notification channels (comma separated)'
        required: true
        default: 'github,slack'
        type: string

env:
  NODE_VERSION: '18'

jobs:
  # é¡¹ç›®å¥åº·çŠ¶æ€ç›‘æ§
  health-monitoring:
    name: Project Health Monitoring
    runs-on: ubuntu-latest
    outputs:
      health-score: ${{ steps.health.outputs.score }}
      status: ${{ steps.health.outputs.status }}
      issues: ${{ steps.health.outputs.issues }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Calculate project health score
        id: health
        run: |
          node scripts/calculate-health-score.js \
            --output health-score.json

          SCORE=$(cat health-score.json | jq -r '.overall_score')
          STATUS=$(cat health-score.json | jq -r '.status')
          ISSUES=$(cat health-score.json | jq -r '.total_issues')

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT

      - name: Generate health dashboard
        run: |
          node scripts/generate-health-dashboard.js \
            --input health-score.json \
            --output health-dashboard.html

      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: health-report
          path: |
            health-score.json
            health-dashboard.html
          retention-days: 7

  # æ€§èƒ½æŒ‡æ ‡ç›‘æ§
  performance-monitoring:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    needs: health-monitoring
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run performance benchmarks
        run: |
          npm run build
          npm run test:performance

      - name: Analyze performance metrics
        run: |
          node scripts/analyze-performance-trends.js \
            --input test-results/performance/ \
            --baseline performance-baseline.json \
            --output performance-trends.json

      - name: Check performance regressions
        run: |
          node scripts/check-performance-regressions.js \
            --current performance-trends.json \
            --thresholds performance-thresholds.json \
            --output performance-regressions.json

      - name: Generate performance report
        run: |
          node scripts/generate-performance-report.js \
            --input performance-trends.json \
            --output performance-report.html

      - name: Upload performance metrics
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics
          path: |
            performance-trends.json
            performance-regressions.json
            performance-report.html
          retention-days: 7

  # ä¾èµ–æ›´æ–°ç›‘æ§
  dependency-monitoring:
    name: Dependency Monitoring
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Check for outdated dependencies
        run: |
          npm outdated --json > outdated-dependencies.json 2>/dev/null || echo '{}' > outdated-dependencies.json

          # ç”Ÿæˆä¾èµ–æŠ¥å‘Š
          node scripts/generate-dependency-report.js \
            --input outdated-dependencies.json \
            --output dependency-report.html

          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸»è¦ç‰ˆæœ¬æ›´æ–°
          node scripts/check-major-updates.js \
            --input outdated-dependencies.json \
            --output major-updates.json

      - name: Check for security advisories
        run: |
          npm audit --json > security-advisories.json 2>/dev/null || echo '{}' > security-advisories.json

          node scripts/analyze-security-advisories.js \
            --input security-advisories.json \
            --output security-advisory-report.html

      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-monitoring
          path: |
            outdated-dependencies.json
            major-updates.json
            security-advisories.json
            dependency-report.html
            security-advisory-report.html
          retention-days: 7

  # ä»£ç è´¨é‡è¶‹åŠ¿ç›‘æ§
  quality-trend-monitoring:
    name: Quality Trend Monitoring
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Analyze code quality trends
        run: |
          node scripts/analyze-quality-trends.js \
            --git-range="HEAD~10..HEAD" \
            --output quality-trends.json

      - name: Generate quality trend dashboard
        run: |
          node scripts/generate-quality-trend-dashboard.js \
            --input quality-trends.json \
            --output quality-trend-dashboard.html

      - name: Check quality degradation
        run: |
          node scripts/check-quality-degradation.js \
            --current quality-trends.json \
            --thresholds quality-thresholds.json \
            --output quality-degradation.json

      - name: Upload quality trend reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-trends
          path: |
            quality-trends.json
            quality-trend-dashboard.html
            quality-degradation.json
          retention-days: 7

  # é€šçŸ¥èšåˆå’Œå‘é€
  notification-aggregation:
    name: Notification Aggregation
    runs-on: ubuntu-latest
    needs: [health-monitoring, performance-monitoring, dependency-monitoring, quality-trend-monitoring]
    if: always() && !cancelled()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all monitoring reports
        uses: actions/download-artifact@v4
        with:
          path: monitoring-reports/

      - name: Aggregate monitoring data
        run: |
          node scripts/aggregate-monitoring-data.js \
            --input-dir monitoring-reports \
            --output monitoring-summary.json \
            --project-name "Taro Bluetooth Print v2.0"

      - name: Generate notification content
        run: |
          node scripts/generate-notification-content.js \
            --input monitoring-summary.json \
            --type "${{ github.event.inputs.notification-type || 'daily-report' }}" \
            --output notification-content.json

      - name: Send GitHub notification
        if: contains(github.event.inputs.channels, 'github') || github.event.inputs.channels == ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const content = JSON.parse(fs.readFileSync('monitoring-reports/notification-content.json', 'utf8'));

              if (github.event_name === 'pull_request') {
                // PRè¯„è®º
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: content.github.pr_comment
                });
              } else if (github.event_name === 'push' && github.ref == 'refs/heads/main') {
                // åˆ›å»ºcommitçŠ¶æ€
                github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: context.sha,
                  state: content.github.status.state,
                  target_url: content.github.status.target_url,
                  description: content.github.status.description,
                  context: 'monitoring/health-check'
                });
              }

            } catch (error) {
              console.log('Failed to send GitHub notification:', error.message);
            }

      - name: Send Slack notification
        if: contains(github.event.inputs.channels, 'slack') && env.SLACK_WEBHOOK_URL != ''
        run: |
          node scripts/send-slack-notification.js \
            --webhook "${{ secrets.SLACK_WEBHOOK_URL }}" \
            --content monitoring-reports/notification-content.json

      - name: Send Email notification
        if: contains(github.event.inputs.channels, 'email') && env.SMTP_CONFIG != ''
        run: |
          node scripts/send-email-notification.js \
            --config "${{ secrets.SMTP_CONFIG }}" \
            --content monitoring-reports/notification-content.json

      - name: Send Discord notification
        if: contains(github.event.inputs.channels, 'discord') && env.DISCORD_WEBHOOK_URL != ''
        run: |
          node scripts/send-discord-notification.js \
            --webhook "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            --content monitoring-reports/notification-content.json

      - name: Update monitoring dashboard
        if: github.ref == 'refs/heads/main'
        run: |
          node scripts/update-monitoring-dashboard.js \
            --input monitoring-summary.json \
            --output monitoring-dashboard.html

      - name: Deploy monitoring dashboard
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: monitoring-dashboard.html
          destination_dir: monitoring

  # è‡ªåŠ¨åŒ–é—®é¢˜åˆ›å»º
  automated-issue-creation:
    name: Automated Issue Creation
    runs-on: ubuntu-latest
    needs: notification-aggregation
    if: failure() && github.ref == 'refs/heads/main'
    steps:
      - name: Download monitoring data
        uses: actions/download-artifact@v4
        with:
          name: monitoring-summary
          path: monitoring-data/

      - name: Create automated issue for failures
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const monitoringData = JSON.parse(fs.readFileSync('monitoring-data/monitoring-summary.json', 'utf8'));

              // æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡é—®é¢˜éœ€è¦åˆ›å»ºissue
              if (monitoringData.health_score < 50 ||
                  monitoringData.performance_regressions.length > 0 ||
                  monitoringData.critical_security_issues > 0) {

                const issueTitle = `ğŸš¨ è‡ªåŠ¨åŒ–ç›‘æ§è­¦æŠ¥ - ${new Date().toLocaleDateString('zh-CN')}`;
                const issueBody = this.generateIssueBody(monitoringData);

                // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç±»ä¼¼çš„open issue
                const existingIssues = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: ['monitoring', 'auto-generated']
                });

                const similarIssue = existingIssues.data.find(issue =>
                  issue.title.includes('è‡ªåŠ¨åŒ–ç›‘æ§è­¦æŠ¥')
                );

                if (!similarIssue) {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: issueTitle,
                    body: issueBody,
                    labels: ['monitoring', 'auto-generated', 'high-priority']
                  });

                  console.log('Created automated issue for monitoring alerts');
                } else {
                  // æ›´æ–°ç°æœ‰issue
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: similarIssue.number,
                    body: `## ğŸ“Š ç›‘æ§æ›´æ–° (${new Date().toLocaleString('zh-CN')})\n\n${issueBody}`
                  });

                  console.log('Updated existing monitoring issue');
                }
              }

            } catch (error) {
              console.log('Failed to create automated issue:', error.message);
            }

  generateIssueBody(monitoringData) {
    let body = `## ğŸ“Š é¡¹ç›®å¥åº·çŠ¶æ€è­¦æŠ¥\n\n`;
    body += `**å¥åº·è¯„åˆ†**: ${monitoringData.health_score}/100 (${monitoringData.health_status})\n\n`;

    if (monitoringData.critical_issues > 0) {
      body += `### ğŸš¨ ä¸¥é‡é—®é¢˜ (${monitoringData.critical_issues}ä¸ª)\n\n`;
      monitoringData.issues.filter(issue => issue.severity === 'critical').forEach(issue => {
        body += `- **${issue.category}**: ${issue.description}\n`;
      });
      body += '\n';
    }

    if (monitoringData.performance_regressions.length > 0) {
      body += `### ğŸ“‰ æ€§èƒ½å›å½’\n\n`;
      monitoringData.performance_regressions.forEach(regression => {
        body += `- **${regression.metric}**: ${regression.change}%\n`;
      });
      body += '\n';
    }

    body += `### ğŸ”— ç›¸å…³é“¾æ¥\n`;
    body += `- [ç›‘æ§ä»ªè¡¨æ¿](https://${{ github.repository }}.github.io/monitoring)\n`;
    body += `- [è¯¦ç»†æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;

    body += `### ğŸ“‹ å»ºè®®è¡ŒåŠ¨\n`;
    body += `1. æŸ¥çœ‹è¯¦ç»†çš„ç›‘æ§æŠ¥å‘Š\n`;
    body += `2. ä¼˜å…ˆå¤„ç†ä¸¥é‡é—®é¢˜\n`;
    body += `3. è¯„ä¼°æ€§èƒ½å›å½’çš„å½±å“\n`;
    body += `4. åˆ¶å®šæ”¹è¿›è®¡åˆ’\n\n`;

    body += `---\n`;
    body += `*æ­¤issueç”±ç›‘æ§ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*`;

    return body;
  }