name: Security and Dependency Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨5ç‚¹è¿è¡Œå®‰å…¨æ‰«æ
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      scan-level:
        description: 'Scan level'
        required: true
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - comprehensive
      fail-on-issues:
        description: 'Fail workflow on security issues'
        required: true
        default: 'true'
        type: boolean

env:
  NODE_VERSION: '18'
  # å®‰å…¨æ‰«æé…ç½®
  AUDIT_LEVEL: 'moderate'
  SNYK_SEVERITY: 'high'
  LICENSE_WHITELIST: 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;CC0-1.0;Unlicense'

jobs:
  # ä¾èµ–å®‰å…¨æ‰«æ
  dependency-security-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scanner: [npm-audit, snyk, retire]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        if: matrix.scanner == 'npm-audit'
        run: |
          echo "ğŸ” è¿è¡Œnpm audit..."

          # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
          npm audit --json > npm-audit-report.json 2>/dev/null || echo '{}' > npm-audit-report.json

          # è¿è¡Œauditæ£€æŸ¥
          if [ "${{ github.event.inputs.fail-on-issues }}" == "true" ]; then
            npm audit --audit-level="${{ env.AUDIT_LEVEL }}"
          else
            npm audit --audit-level="${{ env.AUDIT_LEVEL }}" || echo "âš ï¸ npm auditå‘ç°é—®é¢˜ä½†ç»§ç»­æ‰§è¡Œ"
          fi

      - name: Run Snyk security scan
        if: matrix.scanner == 'snyk'
        uses: snyk/actions/node@master
        continue-on-error: ${{ github.event.inputs.fail-on-issues != 'true' }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY }} --json > snyk-report.json 2>/dev/null || echo '{}' > snyk-report.json

      - name: Run Retire.js for known vulnerabilities
        if: matrix.scanner == 'retire'
        run: |
          echo "ğŸ” è¿è¡ŒRetire.jsæ‰«æ..."
          npm install -g retire

          # ç”ŸæˆRetire.jsæŠ¥å‘Š
          retire --outputformat json --outputpath retire-report.json || echo '{}' > retire-report.json

          # æ£€æŸ¥æ¼æ´
          retire --outputformat text > retire-report.txt || echo "Retire.jsæ‰«æå®Œæˆ"

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-${{ matrix.scanner }}
          path: |
            npm-audit-report.json
            snyk-report.json
            retire-report.json
            retire-report.txt
            .snyk/
          retention-days: 30

  # è®¸å¯è¯åˆè§„æ£€æŸ¥
  license-compliance-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check license compliance
        run: |
          echo "ğŸ” æ£€æŸ¥è®¸å¯è¯åˆè§„æ€§..."

          # å®‰è£…license-checker
          npm install -g license-checker

          # ç”Ÿæˆè®¸å¯è¯æŠ¥å‘Š
          license-checker --json > license-report.json 2>/dev/null || echo '{}' > license-report.json

          # æ£€æŸ¥è®¸å¯è¯ç™½åå•
          license-checker --onlyAllow '${{ env.LICENSE_WHITELIST }}' --summary > license-summary.txt 2>/dev/null || echo "è®¸å¯è¯æ£€æŸ¥å®Œæˆ"

          # ç”Ÿæˆè®¸å¯è¯ç»Ÿè®¡
          node scripts/generate-license-summary.js --input license-report.json --output license-stats.json

      - name: Check for forbidden licenses
        run: |
          node scripts/check-forbidden-licenses.js \
            --input license-report.json \
            --whitelist '${{ env.LICENSE_WHITELIST }}' \
            --output forbidden-licenses.json

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            license-report.json
            license-summary.txt
            license-stats.json
            forbidden-licenses.json
          retention-days: 30

  # ä»£ç å®‰å…¨åˆ†æ
  code-security-analysis:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        analyzer: [eslint-security, semgrep, codeql]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint security rules
        if: matrix.analyzer == 'eslint-security'
        run: |
          echo "ğŸ” è¿è¡ŒESLintå®‰å…¨è§„åˆ™..."

          # è¿è¡Œå®‰å…¨ç‰¹å®šçš„ESLintè§„åˆ™
          npx eslint src/ --ext .ts,.tsx \
            --config .eslintrc.security.js \
            --format=json > eslint-security-report.json 2>/dev/null || echo '{}' > eslint-security-report.json

          # ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š
          npx eslint src/ --ext .ts,.tsx \
            --config .eslintrc.security.js \
            --format=compact > eslint-security-report.txt 2>/dev/null || echo "ESLintå®‰å…¨æ£€æŸ¥å®Œæˆ"

      - name: Initialize CodeQL
        if: matrix.analyzer == 'codeql'
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: Autobuild for CodeQL
        if: matrix.analyzer == 'codeql'
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        if: matrix.analyzer == 'codeql'
        uses: github/codeql-action/analyze@v2

      - name: Run Semgrep security scan
        if: matrix.analyzer == 'semgrep'
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/javascript
            p/typescript
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload security analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-security-report-${{ matrix.analyzer }}
          path: |
            eslint-security-report.json
            eslint-security-report.txt
          retention-days: 30

  # å¯†é’¥å’Œæ•æ„Ÿä¿¡æ¯æ‰«æ
  secrets-scanning:
    name: Secrets and Sensitive Data Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --json

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Scan for sensitive patterns
        run: |
          echo "ğŸ” æ‰«ææ•æ„Ÿä¿¡æ¯æ¨¡å¼..."

          # æ£€æŸ¥å¸¸è§æ•æ„Ÿä¿¡æ¯æ¨¡å¼
          node scripts/scan-sensitive-patterns.js \
            --input-dir src/ \
            --output sensitive-patterns-report.json

      - name: Upload secrets scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secrets-scan-reports
          path: |
            sensitive-patterns-report.json
            trufflehog-report.json
            gitleaks-report.json
          retention-days: 30

  # ä¾›åº”é“¾å®‰å…¨æ£€æŸ¥
  supply-chain-security:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate dependency tree
        run: |
          echo "ğŸ” ç”Ÿæˆä¾èµ–æ ‘..."
          npm ls --json --long > dependency-tree.json 2>/dev/null || echo '{}' > dependency-tree.json

          # ç”Ÿæˆä¾èµ–å›¾
          node scripts/generate-dependency-graph.js --input package.json --output dependency-graph.json

      - name: Check for typosquatting attacks
        run: |
          node scripts/check-typosquatting.js \
            --input dependency-tree.json \
            --output typosquatting-report.json

      - name: Analyze dependency risk
        run: |
          node scripts/analyze-dependency-risk.js \
            --input dependency-tree.json \
            --output dependency-risk-report.json

      - name: Upload supply chain reports
        uses: actions/upload-artifact@v4
        with:
          name: supply-chain-reports
          path: |
            dependency-tree.json
            dependency-graph.json
            typosquatting-report.json
            dependency-risk-report.json
          retention-days: 30

  # å®‰å…¨æŠ¥å‘Šèšåˆ
  security-report-aggregation:
    name: Security Report Aggregation
    runs-on: ubuntu-latest
    needs: [dependency-security-scan, license-compliance-check, code-security-analysis, secrets-scanning, supply-chain-security]
    if: always() && !cancelled()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all security reports
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts/

      - name: Generate comprehensive security report
        run: |
          node scripts/generate-security-report.js \
            --input-dir security-artifacts \
            --output-dir security-report \
            --project-name "Taro Bluetooth Print v2.0"

      - name: Calculate security score
        run: |
          node scripts/calculate-security-score.js \
            --input-dir security-artifacts \
            --output security-score.json

      - name: Upload comprehensive security report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-report
          path: |
            security-report/
            security-score.json
          retention-days: 90

      - name: Comment on PR with security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let commentBody = '## ğŸ”’ å®‰å…¨æ‰«ææŠ¥å‘Š\n\n';

            try {
              const securityScore = JSON.parse(fs.readFileSync('security-artifacts/security-score.json', 'utf8'));

              commentBody += `### ğŸ›¡ï¸ å®‰å…¨è¯„åˆ†: ${securityScore.overall_score}/100\n\n`;

              commentBody += '| å®‰å…¨ç±»åˆ« | è¯„åˆ† | çŠ¶æ€ |\n';
              commentBody += '|----------|------|------|\n';

              const categories = [
                { key: 'dependency_score', label: 'ä¾èµ–å®‰å…¨', icon: 'ğŸ“¦' },
                { key: 'license_score', label: 'è®¸å¯è¯åˆè§„', icon: 'ğŸ“„' },
                { key: 'code_score', label: 'ä»£ç å®‰å…¨', icon: 'ğŸ’»' },
                { key: 'secrets_score', label: 'æ•æ„Ÿä¿¡æ¯', icon: 'ğŸ”‘' },
                { key: 'supply_chain_score', label: 'ä¾›åº”é“¾', icon: 'ğŸ”—' }
              ];

              categories.forEach(category => {
                const score = securityScore[category.key] || 0;
                const status = score >= 80 ? 'âœ… å®‰å…¨' : score >= 60 ? 'âš ï¸ éœ€å…³æ³¨' : 'âŒ æœ‰é£é™©';
                commentBody += `| ${category.icon} ${category.label} | ${score}/100 | ${status} |\n`;
              });

              commentBody += '\n';

              // æ·»åŠ å®‰å…¨é—®é¢˜æ‘˜è¦
              if (securityScore.issues && securityScore.issues.length > 0) {
                commentBody += '### ğŸš¨ å‘ç°çš„å®‰å…¨é—®é¢˜\n\n';
                securityScore.issues.slice(0, 5).forEach(issue => {
                  commentBody += `- **${issue.severity}**: ${issue.title} (${issue.tool})\n`;
                });

                if (securityScore.issues.length > 5) {
                  commentBody += `- ... è¿˜æœ‰ ${securityScore.issues.length - 5} ä¸ªé—®é¢˜\n`;
                }
                commentBody += '\n';
              }

              // å®‰å…¨é—¨ç¦çŠ¶æ€
              const passed = securityScore.overall_score >= 70;
              commentBody += passed
                ? 'ğŸ‰ **å®‰å…¨æ£€æŸ¥é€šè¿‡** - ä»£ç å®‰å…¨æ€§ç¬¦åˆè¦æ±‚\n'
                : 'âš ï¸ **å‘ç°å®‰å…¨é—®é¢˜** - å»ºè®®åœ¨åˆå¹¶å‰å¤„ç†å®‰å…¨é—®é¢˜\n';

              if (!passed && securityScore.critical_issues > 0) {
                commentBody += '\nâŒ **å‘ç°å…³é”®å®‰å…¨é—®é¢˜ï¼Œå¿…é¡»ä¿®å¤åæ‰èƒ½åˆå¹¶**\n';
              }

            } catch (error) {
              commentBody += 'âš ï¸ æ— æ³•è·å–å®‰å…¨æ‰«ææ•°æ®\n\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

  # å®‰å…¨é—¨ç¦æ£€æŸ¥
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: security-report-aggregation
    if: always() && needs.security-report-aggregation.result == 'success'
    steps:
      - name: Download security score
        uses: actions/download-artifact@v4
        with:
          name: comprehensive-security-report
          path: security-reports/

      - name: Check security gate
        run: |
          if [ -f "security-reports/security-score.json" ]; then
            node scripts/security-gate-checker.js \
              --input security-reports/security-score.json \
              --thresholds security-thresholds.json \
              --output security-gate-result.json

            PASSED=$(cat security-gate-result.json | jq -r '.passed')

            if [ "$PASSED" = "false" ]; then
              echo "âŒ å®‰å…¨é—¨ç¦æ£€æŸ¥å¤±è´¥"
              echo "è¯·æŸ¥çœ‹å®‰å…¨æŠ¥å‘Šå¹¶ä¿®å¤ç›¸å…³é—®é¢˜"
              exit 1
            else
              echo "âœ… å®‰å…¨é—¨ç¦æ£€æŸ¥é€šè¿‡"
            fi
          else
            echo "âš ï¸ å®‰å…¨é—¨ç¦æ£€æŸ¥ç»“æœä¸å¯ç”¨"
          fi

  # å®‰å…¨æŠ¥å‘Šå‘å¸ƒ
  security-report-publish:
    name: Security Report Publishing
    runs-on: ubuntu-latest
    needs: [security-gate]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all security reports
        uses: actions/download-artifact@v4
        with:
          path: all-security-reports/

      - name: Deploy security reports to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: all-security-reports/comprehensive-security-report
          destination_dir: security-reports

      - name: Notify security report status
        run: |
          echo "ğŸ”’ å®‰å…¨æŠ¥å‘Šå·²ç”Ÿæˆ"
          echo "ğŸ“ˆ æŸ¥çœ‹æŠ¥å‘Š: https://${{ github.repository }}.github.io/security-reports"