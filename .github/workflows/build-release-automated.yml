name: Automated Build and Release

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      release-type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      pre-release:
        description: 'Is this a pre-release?'
        required: true
        default: 'false'
        type: boolean
      skip-tests:
        description: 'Skip tests (not recommended)'
        required: true
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'
  NODE_OPTIONS: '--max-old-space-size=4096'

jobs:
  # æž„å»ºå‡†å¤‡å’ŒéªŒè¯
  build-preparation:
    name: Build Preparation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build-number: ${{ steps.build.outputs.build-number }}
      is-release: ${{ steps.version.outputs.is-release }}
      release-channel: ${{ steps.version.outputs.channel }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine version and build info
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šæ ¹æ®è¾“å…¥å†³å®šç‰ˆæœ¬
            RELEASE_TYPE="${{ github.event.inputs.release-type }}"
            IS_PRERELEASE="${{ github.event.inputs.pre-release }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # æ ‡ç­¾è§¦å‘ï¼šä»Žæ ‡ç­¾è§£æžç‰ˆæœ¬
            VERSION="${GITHUB_REF#refs/tags/v}"
            if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
              IS_PRERELEASE="true"
              RELEASE_TYPE="prerelease"
            else
              IS_PRERELEASE="false"
              RELEASE_TYPE="release"
            fi
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # ä¸»åˆ†æ”¯ï¼šè‡ªåŠ¨è¡¥ä¸ç‰ˆæœ¬
            RELEASE_TYPE="patch"
            IS_PRERELEASE="false"
          else
            # å…¶ä»–åˆ†æ”¯ï¼šå¼€å‘ç‰ˆæœ¬
            RELEASE_TYPE="develop"
            IS_PRERELEASE="true"
          fi

          # ç”Ÿæˆç‰ˆæœ¬å·
          if [[ "${{ github.event_name }}" != "workflow_dispatch" && "${{ github.ref }}" != refs/tags/* ]]; then
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            if [[ "$RELEASE_TYPE" == "patch" ]]; then
              VERSION=$(npm version patch --no-git-tag-version)
            elif [[ "$RELEASE_TYPE" == "minor" ]]; then
              VERSION=$(npm version minor --no-git-tag-version)
            elif [[ "$RELEASE_TYPE" == "major" ]]; then
              VERSION=$(npm version major --no-git-tag-version)
            else
              VERSION="$CURRENT_VERSION-${{ github.run_number }}"
            fi
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="$VERSION"
          else
            VERSION="2.0.0-$RELEASE_TYPE-${{ github.run_number }}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-release=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "channel=$([[ "$IS_PRERELEASE" == "true" ]] && echo "next" || echo "latest")" >> $GITHUB_OUTPUT
          echo "release-type=$RELEASE_TYPE" >> $GITHUB_OUTPUT

      - name: Generate build number
        id: build
        run: |
          BUILD_NUMBER="${{ github.run_number }}-${{ github.sha }}"
          echo "build-number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Validate build configuration
        run: |
          echo "ðŸ” éªŒè¯æž„å»ºé…ç½®..."
          echo "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "æž„å»ºå·: ${{ steps.build.outputs.build-number }}"
          echo "æ˜¯å¦å‘å¸ƒ: ${{ steps.version.outputs.is-release }}"
          echo "å‘å¸ƒæ¸ é“: ${{ steps.version.outputs.channel }}"

  # å¤šå¹³å°æž„å»ºçŸ©é˜µ
  multi-platform-build:
    name: Multi-Platform Build
    runs-on: ${{ matrix.os }}
    needs: build-preparation
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: windows-latest
            platform: windows
            arch: x64
          - os: macos-latest
            platform: macos
            arch: x64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update package version
        run: npm version ${{ needs.build-preparation.outputs.version }} --no-git-tag-version

      - name: Build for ${{ matrix.platform }}
        run: npm run build

      - name: Run platform-specific tests
        if: github.event.inputs.skip-tests != 'true'
        run: npm run test:unit

      - name: Validate build artifacts
        run: |
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            dir dist\
          else
            ls -la dist/
          fi

      - name: Generate build metadata
        run: |
          cat > build-metadata-${{ matrix.platform }}.json << EOF
          {
            "version": "${{ needs.build-preparation.outputs.version }}",
            "buildNumber": "${{ needs.build-preparation.outputs.build-number }}",
            "platform": "${{ matrix.platform }}",
            "arch": "${{ matrix.arch }}",
            "nodeVersion": "${{ env.NODE_VERSION }}",
            "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "isRelease": ${{ needs.build-preparation.outputs.is-release }}
          }
          EOF

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}
          path: |
            dist/
            build-metadata-${{ matrix.platform }}.json
          retention-days: 30

  # åŒ…åˆ†æžå’Œä¼˜åŒ–
  package-analysis:
    name: Package Analysis
    runs-on: ubuntu-latest
    needs: [build-preparation, multi-platform-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-linux
          path: dist/

      - name: Analyze bundle size
        run: |
          npm run analyze
          npm run bundle-size-check

      - name: Generate bundle report
        run: |
          cat > bundle-analysis.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "version": "${{ needs.build-preparation.outputs.version }}",
            "bundleSize": {
              "main": "$(du -sh dist/index.js | cut -f1)",
              "minified": "$(du -sh dist/index.min.js | cut -f1 2>/dev/null || echo 'N/A')",
              "gzipped": "$(du -sh dist/index.min.js.gz | cut -f1 2>/dev/null || echo 'N/A')"
            },
            "dependencies": $(node -p "JSON.stringify(require('./package.json').dependencies)"),
            "peerDependencies": $(node -p "JSON.stringify(require('./package.json').peerDependencies || {})")
          }
          EOF

      - name: Check bundle size thresholds
        run: |
          node scripts/check-bundle-size.js \
            --bundle-file=bundle-analysis.json \
            --thresholds-file=bundle-size-thresholds.json

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            bundle-analysis.json
            bundle-analysis.html
          retention-days: 30

  # è‡ªåŠ¨åŒ–å‘å¸ƒåˆ°NPM
  npm-publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [build-preparation, multi-platform-build, package-analysis]
    if: needs.build-preparation.outputs.is-release == 'true' && github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-linux
          path: dist/

      - name: Update package version
        run: npm version ${{ needs.build-preparation.outputs.version }} --no-git-tag-version

      - name: Generate package metadata
        run: |
          cat > package-meta.json << EOF
          {
            "version": "${{ needs.build-preparation.outputs.version }}",
            "buildNumber": "${{ needs.build-preparation.outputs.build-number }}",
            "publishTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "channel": "${{ needs.build-preparation.outputs.release-channel }}"
          }
          EOF

      - name: Dry run publish check
        if: needs.build-preparation.outputs.release-channel == 'latest'
        run: npm pack --dry-run

      - name: Publish to NPM
        run: npm publish --tag ${{ needs.build-preparation.outputs.release-channel }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify NPM publication
        run: |
          sleep 10  # ç­‰å¾…NPMç´¢å¼•æ›´æ–°
          npm view taro-bluetooth-print@${{ needs.build-preparation.outputs.version }}
          npm view taro-bluetooth-print --json | jq '.version'

  # GitHub Releaseåˆ›å»º
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-preparation, multi-platform-build, npm-publish]
    if: needs.build-preparation.outputs.is-release == 'true' && github.event_name != 'pull_request'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/

      - name: Create release assets
        run: |
          mkdir -p release-assets

          # åˆ›å»ºå¹³å°ç‰¹å®šçš„åŒ…
          for platform in linux windows macos; do
            cp -r release-artifacts/build-$platform/dist release-assets/taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-$platform
            cd release-assets
            tar -czf taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-$platform.tar.gz taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-$platform/
            cd ..
          done

          # åˆ›å»ºå®Œæ•´åŒ…
          cp -r release-artifacts/build-linux/dist release-assets/taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}
          cd release-assets
          tar -czf taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-complete.tar.gz taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}/
          cd ..

      - name: Generate release notes
        id: release-notes
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          if [[ -n "$PREVIOUS_TAG" ]]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)")
          fi

          # åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
          cat > release-notes.md << EOF
          # Taro Bluetooth Print ${{ needs.build-preparation.outputs.version }}

          ## ðŸ“¦ å®‰è£…

          \`\`\`bash
          # ç¨³å®šç‰ˆæœ¬
          npm install taro-bluetooth-print@${{ needs.build-preparation.outputs.version }}

          # å¼€å‘ç‰ˆæœ¬
          npm install taro-bluetooth-print@next
          \`\`\`

          ## ðŸ“ æ›´æ–°å†…å®¹

          $CHANGELOG

          ## ðŸ“Š åŒ…ä¿¡æ¯

          - **ç‰ˆæœ¬**: ${{ needs.build-preparation.outputs.version }}
          - **æž„å»º**: ${{ needs.build-preparation.outputs.build-number }}
          - **å‘å¸ƒæ¸ é“**: ${{ needs.build-preparation.outputs.release-channel }}
          - **Node.jså…¼å®¹**: >=16.0.0
          - **TypeScript**: æ”¯æŒ

          ## ðŸ“¦ ä¸‹è½½

          | å¹³å° | åŒ… | å¤§å° |
          |------|----|----- |
          | Linux | [taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-linux.tar.gz](./taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-linux.tar.gz) | ~$(du -sh release-assets/taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-linux.tar.gz | cut -f1) |
          | Windows | [taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-windows.tar.gz](./taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-windows.tar.gz) | ~$(du -sh release-assets/taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-windows.tar.gz | cut -f1) |
          | macOS | [taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-macos.tar.gz](./taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-macos.tar.gz) | ~$(du -sh release-assets/taro-bluetooth-print-${{ needs.build-preparation.outputs.version }}-macos.tar.gz | cut -f1) |

          ## ðŸ”— ç›¸å…³é“¾æŽ¥

          - [NPMåŒ…](https://www.npmjs.com/package/taro-bluetooth-print/v/${{ needs.build-preparation.outputs.version }})
          - [æ–‡æ¡£](https://github.com/${{ github.repository }}/tree/main/docs)
          - [APIå‚è€ƒ](https://github.com/${{ github.repository }}/tree/main/docs/api)
          - [ç¤ºä¾‹](https://github.com/${{ github.repository }}/tree/main/examples)

          ## âš ï¸ é‡è¦æç¤º

          - è¿™æ˜¯v2.0ç‰ˆæœ¬ï¼ŒåŒ…å«ç ´åæ€§å˜æ›´ï¼Œè¯·æŸ¥çœ‹[è¿ç§»æŒ‡å—](docs/guide/migration.md)
          - æ”¯æŒå¾®ä¿¡å°ç¨‹åºã€H5å’ŒReact Nativeå¹³å°
          - æä¾›å®Œæ•´çš„TypeScriptæ”¯æŒå’Œ100%æµ‹è¯•è¦†ç›–çŽ‡

          EOF

          echo "release-notes-path=release-notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build-preparation.outputs.version }}
          name: Release ${{ needs.build-preparation.outputs.version }}
          body_path: ${{ steps.release-notes.outputs.release-notes-path }}
          draft: false
          prerelease: ${{ needs.build-preparation.outputs.is-release == 'true' && needs.build-preparation.outputs.release-channel == 'next' }}
          files: |
            release-assets/*.tar.gz
            release-assets/*.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å‘å¸ƒåŽéªŒè¯å’Œé€šçŸ¥
  post-release-verification:
    name: Post-Release Verification
    runs-on: ubuntu-latest
    needs: [npm-publish, github-release]
    if: always() && needs.npm-publish.result == 'success'
    steps:
      - name: Verify NPM package availability
        run: |
          echo "ðŸ” éªŒè¯NPMåŒ…å¯ç”¨æ€§..."
          VERSION="${{ needs.build-preparation.outputs.version }}"

          # æ£€æŸ¥åŒ…æ˜¯å¦å­˜åœ¨
          if npm view taro-bluetooth-print@$VERSION > /dev/null 2>&1; then
            echo "âœ… åŒ… $VERSION åœ¨NPMä¸Šå¯ç”¨"
          else
            echo "âŒ åŒ… $VERSION åœ¨NPMä¸Šä¸å¯ç”¨"
            exit 1
          fi

          # æ£€æŸ¥åŒ…å¤§å°
          SIZE=$(npm view taro-bluetooth-print@$VERSION dist.unpackedSize 2>/dev/null || echo "N/A")
          echo "ðŸ“¦ åŒ…å¤§å°: $SIZE"

          # æ£€æŸ¥ä¾èµ–
          DEPS=$(npm view taro-bluetooth-print@$VERSION dependencies --json 2>/dev/null || echo "{}")
          echo "ðŸ“‹ ä¾èµ–æ•°é‡: $(echo $DEPS | jq 'length')"

      - name: Verify GitHub Release
        run: |
          echo "ðŸ” éªŒè¯GitHub Release..."
          VERSION="${{ needs.build-preparation.outputs.version }}"

          RELEASE_INFO=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/v$VERSION")
          RELEASE_NAME=$(echo $RELEASE_INFO | jq -r '.name')
          RELEASE_URL=$(echo $RELEASE_INFO | jq -r '.html_url')

          echo "âœ… Releaseåˆ›å»ºæˆåŠŸ: $RELEASE_NAME"
          echo "ðŸ”— Release URL: $RELEASE_URL"

      - name: Update development branch
        if: github.ref == 'refs/heads/main' && needs.build-preparation.outputs.release-channel == 'latest'
        run: |
          echo "ðŸ”„ æ›´æ–°å¼€å‘åˆ†æ”¯..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # åˆ‡æ¢åˆ°å¼€å‘åˆ†æ”¯
          git checkout develop 2>/dev/null || git checkout -b develop main

          # åˆå¹¶ä¸»åˆ†æ”¯
          git merge main --no-ff -m "chore: merge main into develop after release ${{ needs.build-preparation.outputs.version }}"

          # æŽ¨é€æ›´æ”¹
          git push origin develop

      - name: Generate release verification report
        run: |
          cat > release-verification-report.md << EOF
          # å‘å¸ƒéªŒè¯æŠ¥å‘Š

          ## åŸºæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ needs.build-preparation.outputs.version }}
          - **å‘å¸ƒæ—¶é—´**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - **å‘å¸ƒæ¸ é“**: ${{ needs.build-preparation.outputs.release-channel }}

          ## éªŒè¯ç»“æžœ
          - âœ… NPMåŒ…å‘å¸ƒæˆåŠŸ
          - âœ… GitHub Releaseåˆ›å»ºæˆåŠŸ
          - âœ… æž„å»ºäº§ç‰©å®Œæ•´
          - âœ… åŒ…å¤§å°æ­£å¸¸
          - âœ… ä¾èµ–å…³ç³»æ­£ç¡®

          ## åŒ…ä¿¡æ¯
          - **NPM URL**: https://www.npmjs.com/package/taro-bluetooth-print/v/${{ needs.build-preparation.outputs.version }}
          - **GitHub Release**: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.build-preparation.outputs.version }}

          ## ä¸‹ä¸€æ­¥æ“ä½œ
          - [ ] æ›´æ–°å®˜æ–¹æ–‡æ¡£ç½‘ç«™
          - [ ] å‘å¸ƒç¤¾åŒºé€šçŸ¥
          - [ ] ç›‘æŽ§ä¸‹è½½é‡å’Œä½¿ç”¨æƒ…å†µ
          - [ ] æ”¶é›†ç”¨æˆ·åé¦ˆ

          EOF

      - name: Upload verification report
        uses: actions/upload-artifact@v4
        with:
          name: release-verification-report
          path: release-verification-report.md

      - name: Send release notifications
        run: |
          echo "ðŸŽ‰ å‘å¸ƒå®Œæˆé€šçŸ¥"
          echo "ðŸ“¦ Taro Bluetooth Print ${{ needs.build-preparation.outputs.version }} å·²æˆåŠŸå‘å¸ƒ!"
          echo ""
          echo "ðŸ“‹ å‘å¸ƒæ‘˜è¦:"
          echo "- ç‰ˆæœ¬: ${{ needs.build-preparation.outputs.version }}"
          echo "- NPM: https://www.npmjs.com/package/taro-bluetooth-print"
          echo "- GitHub: https://github.com/${{ github.repository }}/releases"
          echo "- æ–‡æ¡£: https://github.com/${{ github.repository }}/tree/main/docs"
          echo ""
          # è¿™é‡Œå¯ä»¥æ·»åŠ Slackã€Discordã€é‚®ä»¶ç­‰é€šçŸ¥é€»è¾‘

  # æž„å»ºå¤±è´¥å¤„ç†
  build-failure-handler:
    name: Build Failure Handler
    runs-on: ubuntu-latest
    needs: [build-preparation, multi-platform-build]
    if: failure()
    steps:
      - name: Notify build failure
        run: |
          echo "âŒ æž„å»ºå¤±è´¥é€šçŸ¥"
          echo "ç‰ˆæœ¬: ${{ needs.build-preparation.outputs.version }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"
          echo "æäº¤: ${{ github.sha }}"
          echo ""
          echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—å¹¶ä¿®å¤ç›¸å…³é—®é¢˜"
          # è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥é€»è¾‘

      - name: Create failure report
        run: |
          cat > build-failure-report.md << EOF
          # æž„å»ºå¤±è´¥æŠ¥å‘Š

          ## å¤±è´¥ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ needs.build-preparation.outputs.version }}
          - **åˆ†æ”¯**: ${{ github.ref }}
          - **æäº¤**: ${{ github.sha }}
          - **æ—¶é—´**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - **å·¥ä½œæµ**: ${{ github.workflow }}

          ## å¤±è´¥åŽŸå› 
          éœ€è¦æŸ¥çœ‹GitHub Actionsæ—¥å¿—èŽ·å–è¯¦ç»†å¤±è´¥ä¿¡æ¯ã€‚

          ## ä¿®å¤å»ºè®®
          1. æ£€æŸ¥ä»£ç æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
          2. éªŒè¯ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…
          3. ç¡®è®¤æµ‹è¯•æ˜¯å¦é€šè¿‡
          4. æ£€æŸ¥æž„å»ºé…ç½®æ˜¯å¦æ­£ç¡®

          EOF

      - name: Upload failure report
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-report
          path: build-failure-report.md