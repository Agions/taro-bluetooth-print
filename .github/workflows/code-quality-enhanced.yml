name: Enhanced Code Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨4ç‚¹è¿è¡Œå…¨é¢è´¨é‡æ£€æŸ¥
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      check-level:
        description: 'Check level'
        required: true
        default: 'standard'
        type: choice
        options:
          - basic
          - standard
          - comprehensive
      target-branch:
        description: 'Target branch for comparison'
        required: false
        default: 'main'

env:
  NODE_VERSION: '18'
  # ä»£ç è´¨é‡é˜ˆå€¼
  COVERAGE_THRESHOLD: '80'
  COMPLEXITY_THRESHOLD: '10'
  DUPLICATION_THRESHOLD: '3'
  MAINTAINABILITY_THRESHOLD: 'B'

jobs:
  # ä»£ç è´¨é‡é¢„æ£€æŸ¥
  quality-precheck:
    name: Quality Precheck
    runs-on: ubuntu-latest
    outputs:
      files-changed: ${{ steps.changes.outputs.files-changed }}
      should-run-full: ${{ steps.changes.outputs.should-run-full }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for file changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            FILES_CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD | wc -l)
            echo "files-changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

            # å¦‚æœæ–‡ä»¶å˜æ›´è¶…è¿‡50ä¸ªï¼Œè¿è¡Œå…¨é¢æ£€æŸ¥
            if [ "$FILES_CHANGED" -gt 50 ]; then
              echo "should-run-full=true" >> $GITHUB_OUTPUT
            else
              echo "should-run-full=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "files-changed=0" >> $GITHUB_OUTPUT
            echo "should-run-full=false" >> $GITHUB_OUTPUT
          fi

  # åŸºç¡€ä»£ç è´¨é‡æ£€æŸ¥
  basic-quality-checks:
    name: Basic Quality Checks
    runs-on: ubuntu-latest
    needs: quality-precheck
    if: needs.quality-precheck.outputs.should-run-full == 'true' || github.event.inputs.check-level == 'basic' || github.event.inputs.check-level == 'comprehensive'
    strategy:
      fail-fast: false
      matrix:
        check-type: [eslint, prettier, typescript]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        if: matrix.check-type == 'eslint'
        run: |
          npm run lint -- --format=json --output-file=eslint-report.json
          npm run lint -- --format=checkstyle --output-file=eslint-checkstyle.xml
          npm run lint -- --format=unix > eslint-unix.txt 2>&1 || true

      - name: Run Prettier check
        if: matrix.check-type == 'prettier'
        run: |
          npm run format -- --check
          npx prettier --check 'src/**/*.{ts,tsx,js,jsx,json,md,yml,yaml}' > prettier-report.txt 2>&1 || true

      - name: Run TypeScript check
        if: matrix.check-type == 'typescript'
        run: |
          npx tsc --noEmit --pretty false > typecheck-report.txt 2>&1 || cat typecheck-report.txt
          npx tsc --noEmit --declaration --emitDeclarationOnly --outDir type-declarations 2>/dev/null || true

      - name: Upload basic quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: basic-quality-${{ matrix.check-type }}-reports
          path: |
            eslint-report.json
            eslint-checkstyle.xml
            eslint-unix.txt
            prettier-report.txt
            typecheck-report.txt
            type-declarations/
          retention-days: 7

  # é«˜çº§ä»£ç è´¨é‡åˆ†æ
  advanced-quality-analysis:
    name: Advanced Quality Analysis
    runs-on: ubuntu-latest
    needs: [quality-precheck, basic-quality-checks]
    if: needs.quality-precheck.outputs.should-run-full == 'true' || github.event.inputs.check-level == 'comprehensive'
    strategy:
      fail-fast: false
      matrix:
        analysis-type: [complexity, duplication, maintainability, security-patterns]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install quality analysis tools
        run: |
          npm install -g plato jsinspect eslint-plugin-import eslint-plugin-security typescript-eslint

      - name: Calculate code complexity
        if: matrix.analysis-type == 'complexity'
        run: |
          npx complexity-report --format json --output complexity-report.json src/
          npx complexity-report --format html --output complexity-report.html src/

          # ä½¿ç”¨TypeScriptç‰¹å®šçš„å¤æ‚åº¦åˆ†æ
          npx typescript-estree --ext .ts,.tsx src/ > ts-complexity-report.txt 2>&1 || true

      - name: Detect code duplication
        if: matrix.analysis-type == 'duplication'
        run: |
          npx jsinspect --threshold 10 --ignore "test/**" --json src/ > duplication-report.json 2>/dev/null || echo '{}' > duplication-report.json
          npx jsinspect --threshold 10 --ignore "test/**" src/ > duplication-report.txt 2>/dev/null || echo "No duplication found" > duplication-report.txt

      - name: Analyze maintainability
        if: matrix.analysis-type == 'maintainability'
        run: |
          # ä½¿ç”¨Platoç”Ÿæˆä»£ç è´¨é‡æŠ¥å‘Š
          npx plato -r -d plato-report -t "Taro Bluetooth Print" -x .json src/

          # ç”Ÿæˆå¯ç»´æŠ¤æ€§æŒ‡æ•°
          node scripts/calculate-maintainability.js --input src/ --output maintainability-report.json

      - name: Security pattern analysis
        if: matrix.analysis-type == 'security-patterns'
        run: |
          # è¿è¡Œå®‰å…¨ç›¸å…³çš„ESLintè§„åˆ™
          npx eslint src/ --ext .ts,.tsx --config .eslintrc.security.js --format=json > security-patterns-report.json 2>/dev/null || echo '{}' > security-patterns-report.json

          # æ£€æŸ¥å¸¸è§çš„å®‰å…¨é—®é¢˜
          node scripts/security-pattern-analyzer.js --input src/ --output security-analysis.json

      - name: Upload advanced analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: advanced-quality-${{ matrix.analysis-type }}-reports
          path: |
            complexity-report.*
            duplication-report.*
            maintainability-report.*
            plato-report/
            security-*.json
            ts-complexity-report.txt
          retention-days: 7

  # SonarCloudé›†æˆ
  sonarcloud-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [quality-precheck, basic-quality-checks]
    if: needs.quality-precheck.outputs.should-run-full == 'true' || github.event.inputs.check-level == 'comprehensive'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # SonarCloudéœ€è¦å®Œæ•´çš„Gitå†å²

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate test coverage
        run: |
          npm run test:coverage

      - name: Run SonarCloud scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Download SonarCloud report
        run: |
          # è·å–SonarCloudåˆ†ææŠ¥å‘Š
          curl -s "https://sonarcloud.io/api/measures/component?component=taro-bluetooth-print&metricKeys=coverage,complexity,duplicated_lines_density,ncloc,violations,sqale_rating" > sonar-metrics.json 2>/dev/null || echo '{}' > sonar-metrics.json

      - name: Upload SonarCloud reports
        uses: actions/upload-artifact@v4
        with:
          name: sonarcloud-reports
          path: |
            sonar-metrics.json
            .scannerwork/
          retention-days: 7

  # ä»£ç è´¨é‡è¶‹åŠ¿åˆ†æ
  quality-trend-analysis:
    name: Quality Trend Analysis
    runs-on: ubuntu-latest
    needs: [basic-quality-checks, advanced-quality-analysis, sonarcloud-analysis]
    if: always() && (needs.basic-quality-checks.result == 'success' || needs.advanced-quality-analysis.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all quality artifacts
        uses: actions/download-artifact@v4
        with:
          path: quality-artifacts/

      - name: Generate quality trend report
        run: |
          node scripts/generate-quality-trend.js \
            --artifacts-dir=quality-artifacts \
            --output-dir=quality-trend-report \
            --project-name="Taro Bluetooth Print v2.0"

      - name: Calculate quality score
        run: |
          node scripts/calculate-quality-score.js \
            --artifacts-dir=quality-artifacts \
            --output=quality-score.json \
            --thresholds-file=quality-thresholds.json

      - name: Upload quality trend reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-trend-reports
          path: |
            quality-trend-report/
            quality-score.json
          retention-days: 30

      - name: Comment on PR with quality summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let commentBody = '## ğŸ” ä»£ç è´¨é‡æŠ¥å‘Š\n\n';

            try {
              const qualityScore = JSON.parse(fs.readFileSync('quality-artifacts/quality-score.json', 'utf8'));

              commentBody += `### ğŸ“Š è´¨é‡è¯„åˆ†: ${qualityScore.overall_score}/100\n\n`;

              commentBody += '| æŒ‡æ ‡ | è¯„åˆ† | çŠ¶æ€ |\n';
              commentBody += '|------|------|------|\n';

              const metrics = [
                { key: 'eslint_score', label: 'ä»£ç è§„èŒƒ', icon: 'ğŸ“' },
                { key: 'typescript_score', label: 'ç±»å‹å®‰å…¨', icon: 'ğŸ”·' },
                { key: 'complexity_score', label: 'å¤æ‚åº¦', icon: 'ğŸ”§' },
                { key: 'duplication_score', label: 'é‡å¤ç‡', icon: 'ğŸ“‹' },
                { key: 'maintainability_score', label: 'å¯ç»´æŠ¤æ€§', icon: 'ğŸ› ï¸' },
                { key: 'coverage_score', label: 'æµ‹è¯•è¦†ç›–', icon: 'ğŸ§ª' }
              ];

              metrics.forEach(metric => {
                const score = qualityScore[metric.key] || 0;
                const status = score >= 80 ? 'âœ… ä¼˜ç§€' : score >= 60 ? 'âš ï¸ è‰¯å¥½' : 'âŒ éœ€æ”¹è¿›';
                commentBody += `| ${metric.icon} ${metric.label} | ${score}/100 | ${status} |\n`;
              });

              commentBody += '\n';

              // æ·»åŠ æ”¹è¿›å»ºè®®
              if (qualityScore.recommendations && qualityScore.recommendations.length > 0) {
                commentBody += '### ğŸ’¡ æ”¹è¿›å»ºè®®\n\n';
                qualityScore.recommendations.slice(0, 3).forEach(rec => {
                  commentBody += `- ${rec}\n`;
                });
                commentBody += '\n';
              }

              // è´¨é‡é—¨ç¦çŠ¶æ€
              const passed = qualityScore.overall_score >= 80;
              commentBody += passed
                ? 'ğŸ‰ **ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡** - å¯ä»¥å®‰å…¨åˆå¹¶\n'
                : 'âš ï¸ **ä»£ç è´¨é‡éœ€è¦æ”¹è¿›** - å»ºè®®åœ¨åˆå¹¶å‰å¤„ç†è´¨é‡é—®é¢˜\n';

            } catch (error) {
              commentBody += 'âš ï¸ æ— æ³•è·å–ä»£ç è´¨é‡æ•°æ®\n\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

  # è´¨é‡é—¨ç¦æ£€æŸ¥
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [quality-trend-analysis]
    if: always() && needs.quality-trend-analysis.result == 'success'
    steps:
      - name: Download quality score
        uses: actions/download-artifact@v4
        with:
          name: quality-trend-reports
          path: quality-reports/

      - name: Check quality gate
        run: |
          node scripts/quality-gate-checker.js \
            --input=quality-reports/quality-score.json \
            --thresholds=quality-thresholds.json \
            --output=quality-gate-result.json

      - name: Quality gate decision
        run: |
          if [ -f "quality-gate-result.json" ]; then
            PASSED=$(cat quality-gate-result.json | jq -r '.passed')

            if [ "$PASSED" = "false" ]; then
              echo "âŒ è´¨é‡é—¨ç¦æ£€æŸ¥å¤±è´¥"
              echo "è¯·æŸ¥çœ‹è´¨é‡æŠ¥å‘Šå¹¶ä¿®å¤ç›¸å…³é—®é¢˜"
              exit 1
            else
              echo "âœ… è´¨é‡é—¨ç¦æ£€æŸ¥é€šè¿‡"
            fi
          else
            echo "âš ï¸ è´¨é‡é—¨ç¦æ£€æŸ¥ç»“æœä¸å¯ç”¨"
          fi

  # è´¨é‡æŠ¥å‘Šç”Ÿæˆå’Œå‘å¸ƒ
  quality-report-publish:
    name: Quality Report Publishing
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all quality reports
        uses: actions/download-artifact@v4
        with:
          path: all-quality-reports/

      - name: Generate comprehensive quality report
        run: |
          node scripts/generate-comprehensive-quality-report.js \
            --input-dir=all-quality-reports \
            --output-dir=quality-report \
            --project-name="Taro Bluetooth Print v2.0"

      - name: Deploy quality report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: quality-report
          destination_dir: quality-reports

      - name: Notify quality report status
        run: |
          echo "ğŸ“Š ä»£ç è´¨é‡æŠ¥å‘Šå·²ç”Ÿæˆ"
          echo "ğŸ“ˆ æŸ¥çœ‹æŠ¥å‘Š: https://${{ github.repository }}.github.io/quality-reports"