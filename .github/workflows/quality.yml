name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * 1'

jobs:
  # ç»¼åˆä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: Comprehensive Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          npm run lint -- --format=json --output-file=eslint-report.json
          npm run lint -- --format=checkstyle --output-file=eslint-checkstyle.xml

      - name: Run Prettier check
        run: |
          npm run format -- --check
          npx prettier --check 'src/**/*.{ts,tsx,js,jsx,json,md,yml}' > prettier-report.txt 2>&1 || true

      - name: Run TypeScript check
        run: |
          npx tsc --noEmit --pretty false > typecheck-report.txt 2>&1 || true

      - name: Calculate code complexity
        run: |
          npx complexity-report --output json --format json src/ > complexity-report.json 2>/dev/null || echo '{}' > complexity-report.json

      - name: Run SonarCloud scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: |
            eslint-report.json
            eslint-checkstyle.xml
            prettier-report.txt
            typecheck-report.txt
            complexity-report.json

  # ä¾èµ–å®‰å…¨æ£€æŸ¥
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --json > audit-report.json 2>/dev/null || echo '{}' > audit-report.json
          npm audit --audit-level=moderate

      - name: Check for outdated dependencies
        run: npm outdated --json > outdated-report.json 2>/dev/null || echo '{}' > outdated-report.json

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            audit-report.json
            outdated-report.json
            .snyk

  # è®¸å¯è¯æ£€æŸ¥
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD' --summary > license-summary.txt 2>/dev/null || true
          npx license-checker --json > license-report.json 2>/dev/null || true

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-reports
          path: |
            license-summary.txt
            license-report.json

  # ä»£ç è¦†ç›–ç‡è´¨é‡æ£€æŸ¥
  coverage-quality:
    name: Coverage Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check coverage thresholds
        run: ./scripts/coverage-monitor.sh --check-thresholds --lines 80 --functions 80 --branches 75 --statements 80

      - name: Generate coverage report
        run: npm run coverage:report

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage/
            coverage/reports/

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run performance tests
        run: npm run test:performance

      - name: Analyze bundle size
        run: |
          npm run analyze
          npx bundlesize

      - name: Bundle size comparison
        run: |
          if [ -f "bundle-size.json" ]; then
            node scripts/compare-bundle-size.js
          fi

      - name: Upload performance reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-reports
          path: |
            bundle-analysis.html
            test-results/performance/
            bundle-size.json

  # æ–‡æ¡£è´¨é‡æ£€æŸ¥
  documentation-check:
    name: Documentation Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for TODO/FIXME comments
        run: |
          grep -r "TODO\|FIXME" src/ > todo-comments.txt 2>/dev/null || echo "No TODO/FIXME comments found" > todo-comments.txt

      - name: Check documentation coverage
        run: |
          npx typedoc --excludePrivate --excludeProtected --output docs-api src/
          find docs-api -name "*.html" | wc -l > doc-coverage-count.txt

      - name: Validate markdown files
        run: |
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" | xargs npx markdownlint-cli2 > markdownlint-report.txt 2>/dev/null || true

      - name: Upload documentation reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: documentation-reports
          path: |
            todo-comments.txt
            doc-coverage-count.txt
            markdownlint-report.txt
            docs-api/

  # è´¨é‡é—¨ç¦æ£€æŸ¥
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [quality-check, dependency-check, license-check, coverage-quality, performance-benchmark, documentation-check]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Evaluate quality metrics
        run: |
          # è´¨é‡é—¨ç¦æ£€æŸ¥
          node scripts/quality-gate.js --config=quality-gate.config.json --verbose

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let commentBody = '## ğŸ” ä»£ç è´¨é‡æŠ¥å‘Š\n\n';

            // æ·»åŠ ESLintç»“æœ
            if (fs.existsSync('artifacts/quality-reports/eslint-report.json')) {
              const eslintData = JSON.parse(fs.readFileSync('artifacts/quality-reports/eslint-report.json', 'utf8'));
              commentBody += `### ğŸ“‹ ESLint\n`;
              commentBody += `- é”™è¯¯: ${eslintData.length}\n`;
              commentBody += `- çŠ¶æ€: ${eslintData.length === 0 ? 'âœ… é€šè¿‡' : 'âŒ éœ€è¦ä¿®å¤'}\n\n`;
            }

            // æ·»åŠ è¦†ç›–ç‡ç»“æœ
            if (fs.existsSync('artifacts/coverage-reports/coverage/coverage-summary.json')) {
              const coverageData = JSON.parse(fs.readFileSync('artifacts/coverage-reports/coverage/coverage-summary.json', 'utf8'));
              commentBody += `### ğŸ“Š æµ‹è¯•è¦†ç›–ç‡\n`;
              commentBody += `- è¡Œè¦†ç›–: ${coverageData.total.lines.pct}%\n`;
              commentBody += `- å‡½æ•°è¦†ç›–: ${coverageData.total.functions.pct}%\n`;
              commentBody += `- åˆ†æ”¯è¦†ç›–: ${coverageData.total.branches.pct}%\n`;
              commentBody += `- è¯­å¥è¦†ç›–: ${coverageData.total.statements.pct}%\n\n`;
            }

            // æ·»åŠ å®‰å…¨æ‰«æç»“æœ
            if (fs.existsSync('artifacts/security-reports/audit-report.json')) {
              const auditData = JSON.parse(fs.readFileSync('artifacts/security-reports/audit-report.json', 'utf8'));
              const vulnerabilities = auditData.vulnerabilities || {};
              const totalVulns = Object.keys(vulnerabilities).length;
              commentBody += `### ğŸ”’ å®‰å…¨æ‰«æ\n`;
              commentBody += `- æ¼æ´æ•°é‡: ${totalVulns}\n`;
              commentBody += `- çŠ¶æ€: ${totalVulns === 0 ? 'âœ… å®‰å…¨' : 'âš ï¸ éœ€è¦å…³æ³¨'}\n\n`;
            }

            if (commentBody !== '## ğŸ” ä»£ç è´¨é‡æŠ¥å‘Š\n\n') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

      - name: Generate comprehensive test report
        run: |
          # ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š
          node scripts/generate-test-report.js --project-name="Taro Bluetooth Print" --output-dir=test-reports

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: comprehensive-test-reports
          path: |
            test-reports/
            quality-gate-reports/

      - name: Set quality gate status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // è¿™é‡Œå¯ä»¥æ ¹æ®è´¨é‡æ£€æŸ¥ç»“æœè®¾ç½®PRçŠ¶æ€
            // ä¾‹å¦‚ï¼šè¦æ±‚æ‰€æœ‰æ£€æŸ¥é€šè¿‡æ‰èƒ½åˆå¹¶